Object.defineProperty(exports, '__esModule', { value: true });

var tslib_es6 = require('../../tslib.es6-4b772a84.js');
var React = require('react');
var cn = require('classnames');
var dateFns = require('date-fns');
var hooks = require('@alfalab/hooks');
var coreComponentsButton = require('../../../button');
var reactTransitionGroup = require('react-transition-group');
var utils = require('../../utils.js');

function _interopDefaultLegacy (e) { return e && typeof e === 'object' && 'default' in e ? e : { 'default': e }; }

var React__default = /*#__PURE__*/_interopDefaultLegacy(React);
var cn__default = /*#__PURE__*/_interopDefaultLegacy(cn);

var styles = {"daysTable":"calendar__daysTable_1vsi3","transitLeft":"calendar__transitLeft_1vsi3","transitRight":"calendar__transitRight_1vsi3","dayName":"calendar__dayName_1vsi3","day":"calendar__day_1vsi3","event":"calendar__event_1vsi3","today":"calendar__today_1vsi3","highlighted":"calendar__highlighted_1vsi3","disabled":"calendar__disabled_1vsi3","range":"calendar__range_1vsi3","selected":"calendar__selected_1vsi3","rangeStart":"calendar__rangeStart_1vsi3","firstDay":"calendar__firstDay_1vsi3","lastDay":"calendar__lastDay_1vsi3","left":"calendar__left_1vsi3","daysEnter":"calendar__daysEnter_1vsi3","daysEnterActive":"calendar__daysEnterActive_1vsi3","daysExit":"calendar__daysExit_1vsi3","daysExitActive":"calendar__daysExitActive_1vsi3","right":"calendar__right_1vsi3"};
require('./index.css');

var DaysTable = function (_a) {
    var _b = _a.weeks, weeks = _b === void 0 ? [] : _b, _c = _a.activeMonth, activeMonth = _c === void 0 ? new Date() : _c, highlighted = _a.highlighted, selectedFrom = _a.selectedFrom, selectedTo = _a.selectedTo, getDayProps = _a.getDayProps;
    var activeMonthRef = React.useRef(activeMonth);
    activeMonthRef.current = activeMonth;
    var prevActiveMonth = hooks.usePrevious(activeMonth);
    var direction = prevActiveMonth && (activeMonth < prevActiveMonth ? 'right' : 'left');
    var selection = utils.getSelectionRange(selectedFrom, selectedTo, highlighted);
    var renderHeader = React.useCallback(function () {
        return utils.WEEKDAYS.map(function (dayName) { return (React__default['default'].createElement("th", { className: styles.dayName, key: dayName }, dayName)); });
    }, []);
    var renderDay = function (day) {
        var _a;
        var daySelected = day.selected ||
            (selectedFrom && dateFns.isSameDay(day.date, selectedFrom)) ||
            (selectedTo && dateFns.isSameDay(day.date, selectedTo));
        var inRange = !daySelected && selection && dateFns.isWithinInterval(day.date, selection);
        var firstDay = day.date.getDate() === 1;
        var lastDay = dateFns.isLastDayOfMonth(day.date);
        var transitLeft = firstDay && inRange && selection && day.date > selection.start;
        var transitRight = lastDay && inRange && selection && day.date < selection.end;
        var rangeStart = selection && dateFns.isSameDay(day.date, selection.start);
        var dayProps = getDayProps(day);
        return (React__default['default'].createElement(coreComponentsButton.Button, tslib_es6.__assign({}, dayProps, { ref: function (node) {
                /**
                 * После анимации реф-коллбэк вызывается еще раз, и в него передается null и старый activeMonth.
                 * Поэтому приходится хранить актуальный месяц в рефе и сравнивать с ним.
                 */
                if (dateFns.startOfMonth(day.date).getTime() === activeMonthRef.current.getTime()) {
                    dayProps.ref(node);
                }
            }, type: 'button', view: 'ghost', size: 'xs', disabled: day.disabled, className: cn__default['default'](styles.day, (_a = {},
                _a[styles.selected] = daySelected,
                _a[styles.range] = inRange,
                _a[styles.rangeStart] = rangeStart,
                _a[styles.transitLeft] = transitLeft,
                _a[styles.transitRight] = transitRight,
                _a[styles.today] = dateFns.isToday(day.date),
                _a[styles.firstDay] = firstDay,
                _a[styles.lastDay] = lastDay,
                _a[styles.event] = day.event,
                _a[styles.disabled] = day.disabled,
                _a[styles.highlighted] = highlighted && dateFns.isEqual(day.date, highlighted),
                _a)) }), day.date.getDate()));
    };
    var renderWeek = function (week, weekIdx) { return (React__default['default'].createElement("tr", { key: weekIdx }, week.map(function (day, dayIdx) { return (React__default['default'].createElement("td", { key: day ? day.date.getTime() : dayIdx }, day && renderDay(day))); }))); };
    return (React__default['default'].createElement("table", { className: cn__default['default'](styles.daysTable, direction && styles[direction]) },
        React__default['default'].createElement("thead", null,
            React__default['default'].createElement("tr", null, renderHeader())),
        React__default['default'].createElement(reactTransitionGroup.TransitionGroup, { component: null },
            React__default['default'].createElement(reactTransitionGroup.CSSTransition, { key: activeMonth.getTime(), timeout: 300, classNames: {
                    enter: styles.daysEnter,
                    enterActive: styles.daysEnterActive,
                    exit: styles.daysExit,
                    exitActive: styles.daysExitActive,
                } },
                React__default['default'].createElement("tbody", null, weeks.map(renderWeek))))));
};

exports.DaysTable = DaysTable;
