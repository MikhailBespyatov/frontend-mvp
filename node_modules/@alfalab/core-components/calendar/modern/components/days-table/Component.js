import React, { useRef, useCallback } from 'react';
import cn from 'classnames';
import { startOfMonth, isToday, isEqual, isSameDay, isWithinInterval, isLastDayOfMonth } from 'date-fns';
import { usePrevious } from '@alfalab/hooks';
import { TransitionGroup, CSSTransition } from 'react-transition-group';
import { Button } from '../../../../button/modern';
import { getSelectionRange, WEEKDAYS } from '../../utils.js';

var styles = {"daysTable":"calendar__daysTable_1vsi3","transitLeft":"calendar__transitLeft_1vsi3","transitRight":"calendar__transitRight_1vsi3","dayName":"calendar__dayName_1vsi3","day":"calendar__day_1vsi3","event":"calendar__event_1vsi3","today":"calendar__today_1vsi3","highlighted":"calendar__highlighted_1vsi3","disabled":"calendar__disabled_1vsi3","range":"calendar__range_1vsi3","selected":"calendar__selected_1vsi3","rangeStart":"calendar__rangeStart_1vsi3","firstDay":"calendar__firstDay_1vsi3","lastDay":"calendar__lastDay_1vsi3","left":"calendar__left_1vsi3","daysEnter":"calendar__daysEnter_1vsi3","daysEnterActive":"calendar__daysEnterActive_1vsi3","daysExit":"calendar__daysExit_1vsi3","daysExitActive":"calendar__daysExitActive_1vsi3","right":"calendar__right_1vsi3"};
require('./index.css');

const DaysTable = ({ weeks = [], activeMonth = new Date(), highlighted, selectedFrom, selectedTo, getDayProps, }) => {
    const activeMonthRef = useRef(activeMonth);
    activeMonthRef.current = activeMonth;
    const prevActiveMonth = usePrevious(activeMonth);
    const direction = prevActiveMonth && (activeMonth < prevActiveMonth ? 'right' : 'left');
    const selection = getSelectionRange(selectedFrom, selectedTo, highlighted);
    const renderHeader = useCallback(() => WEEKDAYS.map(dayName => (React.createElement("th", { className: styles.dayName, key: dayName }, dayName))), []);
    const renderDay = (day) => {
        const daySelected = day.selected ||
            (selectedFrom && isSameDay(day.date, selectedFrom)) ||
            (selectedTo && isSameDay(day.date, selectedTo));
        const inRange = !daySelected && selection && isWithinInterval(day.date, selection);
        const firstDay = day.date.getDate() === 1;
        const lastDay = isLastDayOfMonth(day.date);
        const transitLeft = firstDay && inRange && selection && day.date > selection.start;
        const transitRight = lastDay && inRange && selection && day.date < selection.end;
        const rangeStart = selection && isSameDay(day.date, selection.start);
        const dayProps = getDayProps(day);
        return (React.createElement(Button, Object.assign({}, dayProps, { ref: node => {
                /**
                 * После анимации реф-коллбэк вызывается еще раз, и в него передается null и старый activeMonth.
                 * Поэтому приходится хранить актуальный месяц в рефе и сравнивать с ним.
                 */
                if (startOfMonth(day.date).getTime() === activeMonthRef.current.getTime()) {
                    dayProps.ref(node);
                }
            }, type: 'button', view: 'ghost', size: 'xs', disabled: day.disabled, className: cn(styles.day, {
                [styles.selected]: daySelected,
                [styles.range]: inRange,
                [styles.rangeStart]: rangeStart,
                [styles.transitLeft]: transitLeft,
                [styles.transitRight]: transitRight,
                [styles.today]: isToday(day.date),
                [styles.firstDay]: firstDay,
                [styles.lastDay]: lastDay,
                [styles.event]: day.event,
                [styles.disabled]: day.disabled,
                [styles.highlighted]: highlighted && isEqual(day.date, highlighted),
            }) }), day.date.getDate()));
    };
    const renderWeek = (week, weekIdx) => (React.createElement("tr", { key: weekIdx }, week.map((day, dayIdx) => (React.createElement("td", { key: day ? day.date.getTime() : dayIdx }, day && renderDay(day))))));
    return (React.createElement("table", { className: cn(styles.daysTable, direction && styles[direction]) },
        React.createElement("thead", null,
            React.createElement("tr", null, renderHeader())),
        React.createElement(TransitionGroup, { component: null },
            React.createElement(CSSTransition, { key: activeMonth.getTime(), timeout: 300, classNames: {
                    enter: styles.daysEnter,
                    enterActive: styles.daysEnterActive,
                    exit: styles.daysExit,
                    exitActive: styles.daysExitActive,
                } },
                React.createElement("tbody", null, weeks.map(renderWeek))))));
};

export { DaysTable };
