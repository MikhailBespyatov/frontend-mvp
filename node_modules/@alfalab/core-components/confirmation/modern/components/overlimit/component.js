import React, { useRef, useState, useCallback, useEffect } from 'react';
import 'classnames';
import '@alfalab/utils';
import '@alfalab/hooks';
import { CrossCircleMIcon } from '@alfalab/icons-glyph';
import { Button } from '../../../../button/modern';
import { CountdownLoader } from '../countdown-loader/component.js';
import { formatMsAsMinutes } from '../countdown/component.js';

var styles = {"component":"confirmation__component_1iqq7","title":"confirmation__title_1iqq7","description":"confirmation__description_1iqq7","countdown":"confirmation__countdown_1iqq7","loader":"confirmation__loader_1iqq7","timePassed":"confirmation__timePassed_1iqq7","getCodeButton":"confirmation__getCodeButton_1iqq7","alertIcon":"confirmation__alertIcon_1iqq7"};
require('./index.css');

const Overlimit = ({ duration = 60000, buttonRetryText, hasFatalError, onOverlimitRepeatSms, onOverlimitCountdownFinished, text, title, }) => {
    const timerId = useRef(0);
    const start = useRef(0);
    const [isBlockingOver, setIsBlockingOver] = useState(false);
    const [timePassed, setTimePassed] = useState(0);
    const stopTimer = useCallback(() => {
        window.clearInterval(timerId.current);
    }, []);
    const updateProgress = useCallback(() => {
        const passed = Date.now() - start.current;
        if (passed >= duration) {
            setIsBlockingOver(true);
            if (onOverlimitCountdownFinished) {
                onOverlimitCountdownFinished();
            }
            stopTimer();
        }
        else {
            setTimePassed(passed);
        }
    }, [duration, onOverlimitCountdownFinished, stopTimer]);
    const startTimer = useCallback(() => {
        start.current = Date.now();
        updateProgress();
        timerId.current = window.setInterval(updateProgress, 50);
    }, [updateProgress]);
    const handleRepeatSmsButtonClick = useCallback((event) => {
        setIsBlockingOver(false);
        if (onOverlimitRepeatSms) {
            onOverlimitRepeatSms(event);
        }
        startTimer();
    }, [onOverlimitRepeatSms, startTimer]);
    useEffect(() => {
        startTimer();
        return () => {
            stopTimer();
        };
    }, [startTimer, stopTimer]);
    const progress = timePassed / duration;
    return (React.createElement("div", { className: styles.component },
        hasFatalError && (React.createElement("div", { className: styles.alertIcon },
            React.createElement(CrossCircleMIcon, { "data-test-id": 'alert-icon', width: 64, height: 64 }))),
        React.createElement("span", { className: styles.title }, title),
        React.createElement("div", { className: styles.description },
            React.createElement("div", null, text),
            isBlockingOver ? (React.createElement(Button, { size: 'xs', view: 'secondary', onClick: handleRepeatSmsButtonClick, className: styles.getCodeButton }, buttonRetryText)) : (React.createElement("div", { className: styles.countdown },
                React.createElement(CountdownLoader, { progress: progress, className: styles.loader }),
                React.createElement("div", { className: styles.timePassed }, formatMsAsMinutes(duration - timePassed)))))));
};

export { Overlimit };
